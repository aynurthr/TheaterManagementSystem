@model Theater.Application.Modules.PosterModule.Queries.PosterBuyTicketQuery.PosterBuyTicketResponseDto

@{
    ViewBag.Title = @Model.Title;
    ViewBag.BodyId = "Buy-ticket";
}

<section class="poster-details">
    <img class="poster-image" src="@Model.ImageSrc" alt="Poster Image" />
    <div class="poster-item__content">
        <div class="container">
            <div class="poster-item__content__left">
                <h1>@Model.Title</h1>
            </div>
            <div class="poster-item__content__price">
                <h1 id="total-price">0$</h1>
            </div>
        </div>
    </div>
</section>
<section class="booking">
    <div class="container">
        <div class="booking__left">
            <h2>Select Show Date</h2>
            <div class="booking__dates">
                @foreach (var showDate in Model.ShowDates)
                {
                    <button class="booking__date" data-date="@showDate.Date" data-showdateid="@showDate.ShowDateId">@showDate.Date.ToString("dd MMM, HH:mm")</button>
                }
            </div>
            <p class="booking__info">
                Attention! The selected tickets must be paid for by credit card within 30 minutes. Be sure to print the electronic ticket you purchased. It must be presented at the entrance to the theater.
            </p>
            <div class="booking__actions">
                <button class="btn btn--pay" id="pay-button">Pay for Ticket</button>
                <button class="btn btn--cancel">Cancel</button>
            </div>
        </div>
        <div class="booking__right">
            <h2>Seating Chart</h2>
            <div class="booking__seating">
                <div class="seating-chart" id="seating-chart">
                    <!-- Seats will be populated here -->
                </div>
            </div>
        </div>
    </div>
</section>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    $(document).ready(function () {
        var totalPrice = 0;
        var selectedSeats = [];

        function updateTotalPrice() {
            $('#total-price').text(totalPrice + '$');
        }

        $(document).on('click', '.seat', function () {
            var seatPrice = parseFloat($(this).data('price'));
            if ($(this).hasClass('selected')) {
                $(this).removeClass('selected');
                totalPrice -= seatPrice;
                selectedSeats = selectedSeats.filter(seat => seat !== $(this).data('seatnumber'));
            } else {
                $(this).addClass('selected');
                totalPrice += seatPrice;
                selectedSeats.push($(this).data('seatnumber'));
            }
            updateTotalPrice();
        });

        $('.booking__date').click(function () {
            $('.booking__date').removeClass('active');
            $(this).addClass('active');
            var showDateId = $(this).data('showdateid');
            var posterId = @Model.PosterId; // Use the PosterId from the model

            $.ajax({
                url: '/api/posters/' + posterId + '/tickets/' + showDateId,
                method: 'GET',
                success: function (data) {
                    console.log(data); // Log the response data

                    if (!data || !data.seats) {
                        alert('No seats data found.');
                        return;
                    }

                    $('#seating-chart').empty();
                    var rows = {};

                    data.seats.forEach(function (seat) {
                        if (!rows[seat.row]) {
                            rows[seat.row] = [];
                        }
                        rows[seat.row].push(seat);
                    });

                    for (var row in rows) {
                        var rowDiv = $('<div class="seating-row">').append('<div>' + row + '</div>');
                        rows[row].forEach(function (seat) {
                            var seatClass = seat.isPurchased ? 'seat purchased' : 'seat';
                            rowDiv.append(
                                '<span class="' + seatClass + '" data-seatnumber="' + seat.seatNumber + '" data-price="' + seat.price + '">' + seat.seatNumber + '</span>'
                            );
                        });
                        $('#seating-chart').append(rowDiv);
                    }
                },
                error: function () {
                    alert('Failed to load seats. Please try again.');
                }
            });
        });

        $('.booking__date').first().trigger('click');
    });
</script>

